<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shakespeare Digital Variorum</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Georgia', 'Times New Roman', serif;
            background: #f8f9fa;
            color: #2c3e50;
            line-height: 1.6;
            min-height: 100vh;
        }

        /* Header */
        .header {
            background: white;
            padding: 15px 20px;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 1.8em;
            color: #2c3e50;
            font-weight: normal;
        }

        .header-nav {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .nav-btn {
            background: none;
            border: none;
            color: #6c757d;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 14px;
            transition: background-color 0.2s;
        }

        .nav-btn:hover {
            background: #f8f9fa;
        }

        .explain-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
        }

        .explain-btn:hover {
            background: #0056b3;
        }

        .explain-instruction {
            font-size: 12px;
            color: #6c757d;
            margin-left: 10px;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 8px;
            width: 80%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e9ecef;
        }

        .modal-title {
            font-size: 1.5em;
            font-weight: bold;
            color: #2c3e50;
        }

        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
        }

        .close:hover {
            color: #000;
        }

        .upload-section {
            margin-bottom: 25px;
        }

        .upload-section h3 {
            margin-bottom: 10px;
            color: #495057;
        }

        .file-upload {
            border: 2px dashed #ced4da;
            border-radius: 6px;
            padding: 30px;
            text-align: center;
            background: #f8f9fa;
            transition: border-color 0.3s;
        }

        .file-upload:hover {
            border-color: #007bff;
        }

        .file-upload input[type="file"] {
            display: none;
        }

        .file-upload label {
            cursor: pointer;
            color: #007bff;
            font-weight: 500;
        }

        .file-upload label:hover {
            text-decoration: underline;
        }

        .upload-instructions {
            margin-top: 10px;
            font-size: 14px;
            color: #6c757d;
        }

        .uploaded-plays {
            margin-top: 20px;
        }

        .play-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
            margin-bottom: 8px;
        }

        .play-name {
            font-weight: 500;
        }

        .remove-play {
            background: #dc3545;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .remove-play:hover {
            background: #c82333;
        }

        .upload-success {
            background: #d4edda;
            color: #155724;
            padding: 10px 15px;
            border-radius: 4px;
            margin-top: 15px;
            border: 1px solid #c3e6cb;
            display: none;
        }

        .upload-error {
            background: #f8d7da;
            color: #721c24;
            padding: 10px 15px;
            border-radius: 4px;
            margin-top: 15px;
            border: 1px solid #f5c6cb;
            display: none;
        }

        .about-content {
            line-height: 1.7;
            color: #495057;
        }

        .about-content p {
            margin-bottom: 20px;
            text-align: justify;
        }

        .about-footer {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #e9ecef;
            text-align: center;
        }

        .about-footer p {
            margin-bottom: 0;
            color: #6c757d;
        }

        /* Footer About Section */
        .footer-about {
            background: #e9ecef;
            padding: 40px 20px;
            text-align: center;
            margin-top: 50px;
            border-top: 1px solid #ced4da;
        }

        .footer-about h3 {
            font-size: 1.5em;
            color: #2c3e50;
            margin-bottom: 20px;
        }

        .footer-about p {
            max-width: 800px;
            margin: 0 auto 15px auto;
            color: #495057;
            line-height: 1.6;
        }

        .footer-attribution {
            font-size: 0.9em;
            color: #6c757d;
            margin-top: 20px;
        }

        .footer-attribution a {
            color: #007bff;
            text-decoration: underline;
        }

        /* Rights Modal */
        .rights-content {
            line-height: 1.7;
            color: #495057;
        }

        .rights-content h4 {
            color: #2c3e50;
            margin: 25px 0 10px 0;
            font-size: 1.1em;
        }

        .rights-content p {
            margin-bottom: 15px;
        }

        .rights-footer {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #e9ecef;
            text-align: center;
        }

        .rights-footer h4 {
            margin-bottom: 10px;
            color: #2c3e50;
        }

        .rights-footer p {
            margin-bottom: 5px;
            color: #6c757d;
        }

        .rights-footer a {
            color: #007bff;
            text-decoration: none;
        }

        .rights-footer a:hover {
            text-decoration: underline;
        }

        .close-rights-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 25px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 20px;
        }

        .close-rights-btn:hover {
            background: #0056b3;
        }

        /* Main Layout */
        .main-container {
            display: grid;
            grid-template-columns: 280px 1fr 400px;
            height: calc(100vh - 70px);
            gap: 0;
        }

        /* Left Panel - Library & Navigation */
        .left-panel {
            background: white;
            border-right: 1px solid #e9ecef;
            padding: 20px;
            overflow-y: auto;
        }

        .section-title {
            font-weight: bold;
            font-size: 14px;
            color: #495057;
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .play-selector {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-family: inherit;
            font-size: 14px;
            margin-bottom: 20px;
        }

        .navigation-list {
            list-style: none;
        }

        .navigation-list li {
            margin-bottom: 5px;
        }

        .navigation-list a {
            display: block;
            padding: 8px 12px;
            color: #495057;
            text-decoration: none;
            border-radius: 4px;
            font-size: 14px;
            transition: background-color 0.2s;
        }

        .navigation-list a:hover {
            background: #f8f9fa;
        }

        .navigation-list a.active {
            background: #e3f2fd;
            color: #1976d2;
        }

        .navigation-list .sub-item {
            margin-left: 20px;
            font-size: 13px;
        }

        /* Center Panel - Play Text */
        .center-panel {
            background: white;
            padding: 30px;
            overflow-y: auto;
        }

        .scene-title {
            font-size: 1.8em;
            font-weight: bold;
            margin-bottom: 20px;
            color: #2c3e50;
        }

        .scene-separator {
            border-top: 2px solid #e9ecef;
            margin: 20px 0;
        }

        .stage-direction {
            font-style: italic;
            color: #6c757d;
            margin: 15px 0;
        }

        .dialogue {
            margin: 15px 0;
        }

        .character-name {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .dialogue-text {
            margin-left: 20px;
            line-height: 1.8;
        }

        .highlighted {
            background: #e3f2fd;
            padding: 2px 4px;
            border-radius: 3px;
        }

        /* Right Panel - Analysis */
        .right-panel {
            background: white;
            border-left: 1px solid #e9ecef;
            padding: 20px;
            overflow-y: auto;
        }

        .analysis-section {
            margin-bottom: 25px;
        }

        .analysis-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .analysis-title {
            font-weight: bold;
            font-size: 16px;
            color: #2c3e50;
        }

        .copy-btn {
            background: none;
            border: 1px solid #ced4da;
            color: #6c757d;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
        }

        .copy-btn:hover {
            background: #f8f9fa;
        }

        .selection-info {
            font-size: 14px;
            color: #6c757d;
            margin-bottom: 15px;
        }

        .analysis-content {
            font-size: 14px;
            line-height: 1.6;
            color: #495057;
        }

        .analysis-content p {
            margin-bottom: 15px;
        }

        .quoted-text {
            background: #f8f9fa;
            border-left: 3px solid #007bff;
            padding: 10px 15px;
            margin: 15px 0;
            font-style: italic;
        }

        .follow-up-section {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #e9ecef;
        }

        .follow-up-input {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .follow-up-input input {
            flex: 1;
            padding: 10px 12px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-family: inherit;
            font-size: 14px;
        }

        .ask-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .ask-btn:hover {
            background: #0056b3;
        }

        /* Responsive Design */
        @media (max-width: 1200px) {
            .main-container {
                grid-template-columns: 250px 1fr 350px;
            }
        }

        @media (max-width: 768px) {
            .main-container {
                grid-template-columns: 1fr;
                height: auto;
            }
            
            .left-panel, .right-panel {
                display: none;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <h1>Shakespeare Digital Variorum</h1>
        <div class="header-nav">
            <button class="nav-btn" onclick="openSettings()">Settings</button>
            <button class="nav-btn" onclick="openAbout()">About</button>
            <button class="explain-btn" onclick="explainHighlighted()">Explain Highlighted Text</button>
            <span class="explain-instruction">Use your cursor to highlight text in the play, then click this button for analysis.</span>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Settings</div>
                <span class="close" onclick="closeSettings()">&times;</span>
            </div>
            
            <div class="upload-section">
                <h3>Upload Play Texts</h3>
                <div class="file-upload">
                    <input type="file" id="playFile" accept=".txt" onchange="handleFileUpload(event)">
                    <label for="playFile">Choose a play text file (.txt)</label>
                    <div class="upload-instructions">
                        Upload .txt files containing Shakespeare play text. The system will automatically parse them into acts, scenes, and characters.
                    </div>
                </div>
                
                <div class="uploaded-plays" id="uploadedPlays">
                    <!-- Uploaded plays will appear here -->
                </div>
                
                <div class="upload-success" id="uploadSuccess">
                    ✅ Play uploaded successfully! You can now select it from the Library dropdown.
                </div>
                
                <div class="upload-error" id="uploadError">
                    ❌ Error uploading play. Please try again.
                </div>
            </div>
        </div>
    </div>

    <!-- About Modal -->
    <div id="aboutModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">About This Project</div>
                <span class="close" onclick="closeAbout()">&times;</span>
            </div>
            
            <div class="about-content">
                <p>The New Variorum Shakespeare editions have been the gold standard of Shakespearean scholarship for over a century, bringing together the most important critical commentary, textual analysis, and historical context in comprehensive annotated volumes. The Shakespeare Digital Variorum builds on this tradition, harnessing the power of artificial intelligence to make centuries of scholarly insight accessible to everyone, from high school students to veteran researchers.</p>
                
                <p>Our platform integrates authoritative texts based on the Folger Shakespeare Library editions of each play, with commentary from major variorum editions, scholarly databases, and historical sources. We include references to film adaptations, stage productions, and cultural interpretations that show how Shakespeare's works have lived and evolved across different media and eras. Using advanced AI, we can instantly provide plain-language explanations of complex passages, trace the etymology of Early Modern English words as they appear in context, analyze prosodic patterns across scenes and plays, and illuminate the historical events and cultural forces that shaped each work.</p>
                
                <p>The goal is radical accessibility. Whether you're encountering Hamlet's soliloquies for the first time or you're a seasoned scholar investigating textual variants, the Shakespeare Digital Variorum meets you where you are. Students can receive immediate clarification of archaic language and historical references. Researchers can discover thematic connections across the complete canon. Theater practitioners can access centuries of performance history, from Garrick to Branagh to contemporary productions worldwide.</p>
                
                <p>We believe Shakespeare belongs to everyone, not just academics. By connecting scholarly commentary with film clips, performance videos, and multimedia resources, we show how these 400-year-old plays continue to speak to modern audiences. A teenager reading Romeo and Juliet can instantly see how Baz Luhrmann reimagined the balcony scene, while a graduate student can access the full textual apparatus from multiple critical editions.</p>
                
                <p>This isn't about replacing human scholarship but about democratizing it. Every AI-generated insight is grounded in the work of generations of Shakespeare scholars, from the earliest editors to contemporary critics. We've simply made it possible for anyone to access that collective wisdom instantly, searchably, and in conversation with the texts themselves.</p>
                
                <p>The Shakespeare Digital Variorum represents the next evolution of the variorum tradition: comprehensive, scholarly, and designed for universal access. Shakespeare's world is vast, and now everyone can explore all of it.</p>
                
                <div class="about-footer">
                    <p><em>Created by Jack David Carson, Massachusetts Institute of Technology • 2025</em></p>
                </div>
            </div>
        </div>
    </div>

    <!-- Rights & Attribution Modal -->
    <div id="rightsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Rights & Attribution</div>
                <span class="close" onclick="closeRights()">&times;</span>
            </div>
            
            <div class="rights-content">
                <h4>Shakespeare Texts</h4>
                <p>Public domain. Based on editions from the Folger Shakespeare Library and other scholarly sources.</p>
                
                <h4>Scholarly Commentary</h4>
                <p>Used under fair use for educational purposes. Sources include JSTOR, academic publications, and historical editions. Full citations provided with each annotation.</p>
                
                <h4>This Website</h4>
                <p>Licensed under CC BY-NC-SA 4.0 - Free to use for non-commercial, educational purposes with attribution.</p>
                
                <h4>AI Analysis</h4>
                <p>Generated content is provided for educational purposes. Users should verify information with primary sources.</p>
                
                <div class="rights-footer">
                    <h4>Shakespeare Digital Variorum</h4>
                    <p>Created by Jack David Carson, Massachusetts Institute of Technology • 2025</p>
                    <p>Questions about usage? Contact: <a href="mailto:jdcarson@mit.edu">jdcarson@mit.edu</a></p>
                    <button class="close-rights-btn" onclick="closeRights()">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-container">
        <!-- Left Panel - Library & Navigation -->
        <div class="left-panel">
            <div class="section-title">Library</div>
            <select class="play-selector" id="playSelector" onchange="changePlay()">
                <option value="">Select a play...</option>
            </select>

            <div class="section-title">Navigation</div>
            <ul class="navigation-list" id="navigationList">
                <!-- Navigation will be populated dynamically -->
            </ul>
        </div>

        <!-- Center Panel - Play Text -->
        <div class="center-panel" id="playText">
            <div class="scene-title">Welcome to Shakespeare Digital Variorum</div>
            <div class="scene-separator"></div>
            
            <p>Please upload a play text file in Settings to begin analyzing Shakespeare's works.</p>
        </div>

        <!-- Right Panel - Analysis -->
        <div class="right-panel" id="analysisPanel">
            <div class="analysis-section">
                <div class="analysis-header">
                    <div class="analysis-title">Basic Analysis</div>
                    <button class="copy-btn">Copy</button>
                </div>
                <div class="selection-info">No text selected</div>
            </div>

            <div class="analysis-section">
                <div class="analysis-title">Context and Paraphrase</div>
                <div class="analysis-content">
                    <p>Highlight text in the play to get AI-powered analysis.</p>
                </div>
            </div>

            <div class="follow-up-section">
                <div class="analysis-title">Ask a follow-up question</div>
                <div class="follow-up-input">
                    <input type="text" placeholder="Ask a follow-up question..." id="followUpQuestion">
                    <button class="ask-btn" onclick="askFollowUp()">Ask</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let selectedText = '';
        let plays = {};
        let currentPlay = '';
        let currentScene = '';

        // Modal functions
        function openSettings() {
            document.getElementById('settingsModal').style.display = 'block';
        }

        function closeSettings() {
            document.getElementById('settingsModal').style.display = 'none';
        }

        function openAbout() {
            document.getElementById('aboutModal').style.display = 'block';
        }

        function closeAbout() {
            document.getElementById('aboutModal').style.display = 'none';
        }

        function openRights() {
            document.getElementById('rightsModal').style.display = 'block';
        }

        function closeRights() {
            document.getElementById('rightsModal').style.display = 'none';
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const settingsModal = document.getElementById('settingsModal');
            const aboutModal = document.getElementById('aboutModal');
            const rightsModal = document.getElementById('rightsModal');
            if (event.target === settingsModal) {
                closeSettings();
            }
            if (event.target === aboutModal) {
                closeAbout();
            }
            if (event.target === rightsModal) {
                closeRights();
            }
        }

        // File upload handling
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Hide any previous messages
            document.getElementById('uploadSuccess').style.display = 'none';
            document.getElementById('uploadError').style.display = 'none';

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const content = e.target.result;
                    const playName = file.name.replace('.txt', '');
                    
                    console.log('=== FILE UPLOAD DEBUG ===');
                    console.log('File name:', file.name);
                    console.log('File size:', file.size, 'bytes');
                    console.log('Content length:', content.length, 'characters');
                    console.log('First 500 characters:', content.substring(0, 500));
                    console.log('Lines in file:', content.split('\n').length);
                    console.log('=== END DEBUG ===');
                    
                    parsePlayText(playName, content);
                    updatePlaySelector();
                    updateUploadedPlays();
                    
                    // Show success message
                    document.getElementById('uploadSuccess').style.display = 'block';
                    
                    // Auto-select the uploaded play
                    document.getElementById('playSelector').value = playName;
                    loadPlay(playName);
                    
                } catch (error) {
                    console.error('Error processing file:', error);
                    document.getElementById('uploadError').style.display = 'block';
                }
            };
            
            reader.onerror = function() {
                document.getElementById('uploadError').style.display = 'block';
            };
            
            reader.readAsText(file);
        }

        // Parse play text into structured data
        function parsePlayText(playName, content) {
            const lines = content.split('\n');
            const play = {
                name: playName,
                characters: [],
                acts: {},
                scenes: {}
            };

            let currentAct = '';
            let currentScene = '';
            let inDramatisPersonae = false;
            let inScene = false;
            let sceneContent = [];

            console.log('Starting to parse play:', playName);
            console.log('Total lines:', lines.length);

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                
                // Skip empty lines
                if (!line) continue;
                
                // Check for Dramatis Personae section
                if (line.toLowerCase().includes('dramatis personae') || 
                    line.toLowerCase().includes('characters in the play') ||
                    line.toLowerCase().includes('persons represented') ||
                    line.toLowerCase().includes('dramatis personæ')) {
                    console.log('Found Dramatis Personae at line', i, ':', line);
                    inDramatisPersonae = true;
                    inScene = false;
                    continue;
                }

                // Check for Act headers (much more flexible matching)
                if (line.match(/^ACT\s+[IVX]+/i) || 
                    line.match(/^ACT\s+[0-9]+/i) ||
                    line.match(/^ACT\s+[A-Z]+/i) ||
                    line.match(/^THE\s+FIRST\s+PART\s+OF\s+KING\s+HENRY\s+THE\s+FOURTH/i) ||
                    line.match(/^THE\s+SECOND\s+PART\s+OF\s+KING\s+HENRY\s+THE\s+FOURTH/i) ||
                    line.match(/^KING\s+HENRY\s+THE\s+FOURTH/i)) {
                    console.log('Found Act at line', i, ':', line);
                    inDramatisPersonae = false;
                    inScene = false;
                    currentAct = line;
                    play.acts[currentAct] = [];
                    continue;
                }

                // Check for Scene headers (much more flexible matching)
                if (line.match(/^SCENE\s+[IVX]+/i) || 
                    line.match(/^SCENE\s+[0-9]+/i) ||
                    line.match(/^SCENE\s+[A-Z]+/i) ||
                    line.match(/^SCENE\s+[IVX]+\./i) ||
                    line.match(/^SCENE\s+[0-9]+\./i)) {
                    console.log('Found Scene at line', i, ':', line);
                    inScene = true;
                    currentScene = `${currentAct} - ${line}`;
                    play.scenes[currentScene] = [];
                    if (currentAct) {
                        play.acts[currentAct].push(currentScene);
                    }
                    sceneContent = [];
                    continue;
                }

                // Collect characters from Dramatis Personae
                if (inDramatisPersonae && line && !line.startsWith('[') && !line.startsWith('_') && line.length > 0) {
                    const character = line.split('.')[0].trim();
                    if (character && character.length > 0 && character.length < 50 && !play.characters.includes(character)) {
                        play.characters.push(character);
                        console.log('Found character:', character);
                    }
                }

                // Collect scene content
                if (inScene && currentScene && line) {
                    play.scenes[currentScene].push(line);
                }
            }

            // Clean up empty scenes
            Object.keys(play.scenes).forEach(sceneKey => {
                if (play.scenes[sceneKey].length === 0) {
                    delete play.scenes[sceneKey];
                    // Remove from acts too
                    Object.keys(play.acts).forEach(actKey => {
                        play.acts[actKey] = play.acts[actKey].filter(scene => scene !== sceneKey);
                    });
                }
            });

            // If no acts found, try alternative parsing
            if (Object.keys(play.acts).length === 0) {
                console.log('No acts found with standard parsing, trying alternative method...');
                parsePlayTextAlternative(playName, content, play);
            }

            plays[playName] = play;
            console.log('Final parsed play:', playName, play);
            console.log('Acts found:', Object.keys(play.acts));
            console.log('Scenes found:', Object.keys(play.scenes));
            
            // Set as current play if it's the first one
            if (Object.keys(plays).length === 1) {
                currentPlay = playName;
                loadPlay(currentPlay);
            }
        }

        // Alternative parsing method for plays that don't follow standard format
        function parsePlayTextAlternative(playName, content, play) {
            const lines = content.split('\n');
            let currentAct = '';
            let currentScene = '';
            let inScene = false;

            console.log('Trying alternative parsing for:', playName);

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;

                // Look for any line that might be an act (contains "ACT" or roman numerals)
                if (line.match(/ACT/i) || line.match(/^[IVX]+\./i) || line.match(/^[IVX]+\s*$/i)) {
                    console.log('Alternative: Found potential act at line', i, ':', line);
                    currentAct = line;
                    play.acts[currentAct] = [];
                    inScene = false;
                    continue;
                }

                // Look for any line that might be a scene (contains "SCENE" or numbers)
                if (line.match(/SCENE/i) || line.match(/^[0-9]+\./i) || line.match(/^[IVX]+\./i)) {
                    console.log('Alternative: Found potential scene at line', i, ':', line);
                    currentScene = `${currentAct} - ${line}`;
                    play.scenes[currentScene] = [];
                    if (currentAct) {
                        play.acts[currentAct].push(currentScene);
                    }
                    inScene = true;
                    continue;
                }

                // Collect scene content
                if (inScene && currentScene && line) {
                    play.scenes[currentScene].push(line);
                }
            }
        }

        // Update play selector dropdown
        function updatePlaySelector() {
            const selector = document.getElementById('playSelector');
            selector.innerHTML = '<option value="">Select a play...</option>';
            
            Object.keys(plays).forEach(playName => {
                const option = document.createElement('option');
                option.value = playName;
                option.textContent = playName;
                selector.appendChild(option);
            });
        }

        // Update uploaded plays list
        function updateUploadedPlays() {
            const container = document.getElementById('uploadedPlays');
            container.innerHTML = '';
            
            Object.keys(plays).forEach(playName => {
                const playItem = document.createElement('div');
                playItem.className = 'play-item';
                playItem.innerHTML = `
                    <span class="play-name">${playName}</span>
                    <button class="remove-play" onclick="removePlay('${playName}')">Remove</button>
                `;
                container.appendChild(playItem);
            });
        }

        // Remove a play
        function removePlay(playName) {
            delete plays[playName];
            updatePlaySelector();
            updateUploadedPlays();
            
            if (currentPlay === playName) {
                currentPlay = '';
                loadPlay('');
            }
        }

        // Load a play
        function loadPlay(playName) {
            if (!playName || !plays[playName]) {
                document.getElementById('playText').innerHTML = `
                    <div class="scene-title">Welcome to Shakespeare Digital Variorum</div>
                    <div class="scene-separator"></div>
                    <p>Please upload a play text file in Settings to begin analyzing Shakespeare's works.</p>
                `;
                document.getElementById('navigationList').innerHTML = '';
                return;
            }

            const play = plays[playName];
            currentPlay = playName;
            
            console.log('Loading play:', playName, 'with acts:', Object.keys(play.acts));
            
            // Update navigation
            updateNavigation(play);
            
            // Load first scene automatically
            const firstAct = Object.keys(play.acts)[0];
            if (firstAct && play.acts[firstAct] && play.acts[firstAct].length > 0) {
                const firstScene = play.acts[firstAct][0];
                console.log('Loading first scene:', firstScene);
                loadScene(firstScene);
            } else {
                console.log('No scenes found, showing welcome message');
                // If no scenes found, show welcome message
                document.getElementById('playText').innerHTML = `
                    <div class="scene-title">${playName}</div>
                    <div class="scene-separator"></div>
                    <p>Play loaded successfully. Use the navigation to explore acts and scenes.</p>
                    <p><em>Debug: Found ${Object.keys(play.acts).length} acts</em></p>
                `;
            }
        }

        // Update navigation list
        function updateNavigation(play) {
            const navList = document.getElementById('navigationList');
            navList.innerHTML = '';
            
            console.log('Updating navigation for play:', play.name, play);
            
            // Add Dramatis Personae
            if (play.characters.length > 0) {
                const dramatisItem = document.createElement('li');
                dramatisItem.innerHTML = '<a href="#" onclick="showDramatisPersonae()">Dramatis Personae</a>';
                navList.appendChild(dramatisItem);
            }
            
            // Add Acts and Scenes
            Object.keys(play.acts).forEach(actName => {
                const actItem = document.createElement('li');
                actItem.innerHTML = `<a href="#" onclick="showAct('${actName}')">${actName}</a>`;
                navList.appendChild(actItem);
                
                if (play.acts[actName] && play.acts[actName].length > 0) {
                    play.acts[actName].forEach(sceneName => {
                        const sceneItem = document.createElement('li');
                        sceneItem.className = 'sub-item';
                        sceneItem.innerHTML = `<a href="#" onclick="loadScene('${sceneName}')">${sceneName.split(' - ')[1]}</a>`;
                        navList.appendChild(sceneItem);
                    });
                }
            });
        }

        // Load a specific scene
        function loadScene(sceneName) {
            if (!currentPlay || !plays[currentPlay] || !plays[currentPlay].scenes[sceneName]) {
                console.log('Scene not found:', sceneName, 'in play:', currentPlay);
                return;
            }

            currentScene = sceneName;
            const sceneContent = plays[currentPlay].scenes[sceneName];
            
            console.log('Loading scene:', sceneName, 'with content length:', sceneContent.length);
            
            // Update active navigation
            updateActiveNavigation(sceneName);
            
            // Display scene content
            const playText = document.getElementById('playText');
            playText.innerHTML = `
                <div class="scene-title">${sceneName}</div>
                <div class="scene-separator"></div>
                ${formatSceneContent(sceneContent)}
            `;
        }

        // Format scene content for display
        function formatSceneContent(sceneContent) {
            let html = '';
            let inDialogue = false;
            
            if (!sceneContent || sceneContent.length === 0) {
                return '<p><em>No content found for this scene.</em></p>';
            }
            
            sceneContent.forEach(line => {
                if (line.trim() === '') return;
                
                // Check if line is a character name (all caps, no punctuation, reasonable length)
                if (line.match(/^[A-Z\s]+$/) && line.length < 30 && line.length > 2) {
                    if (inDialogue) {
                        html += '</div></div>';
                        inDialogue = false;
                    }
                    html += `<div class="dialogue"><div class="character-name">${line}</div>`;
                    inDialogue = true;
                } else if (line.startsWith('[') && line.endsWith(']')) {
                    if (inDialogue) {
                        html += '</div></div>';
                        inDialogue = false;
                    }
                    html += `<div class="stage-direction">${line}</div>`;
                } else if (inDialogue) {
                    html += `<div class="dialogue-text">${line}</div>`;
                } else {
                    html += `<div class="dialogue-text">${line}</div>`;
                }
            });
            
            if (inDialogue) {
                html += '</div></div>';
            }
            
            return html || '<p><em>Scene content could not be formatted.</em></p>';
        }

        // Update active navigation
        function updateActiveNavigation(itemName) {
            const navLinks = document.querySelectorAll('.navigation-list a');
            navLinks.forEach(link => {
                link.classList.remove('active');
                if (link.textContent === itemName || 
                    link.textContent === itemName.split(' - ')[1] ||
                    (itemName === 'dramatis' && link.textContent === 'Dramatis Personae')) {
                    link.classList.add('active');
                }
            });
        }

        // Show Dramatis Personae
        function showDramatisPersonae() {
            if (!currentPlay || !plays[currentPlay]) return;
            
            const characters = plays[currentPlay].characters;
            const playText = document.getElementById('playText');
            
            // Update active navigation
            updateActiveNavigation('dramatis');
            
            playText.innerHTML = `
                <div class="scene-title">Dramatis Personae</div>
                <div class="scene-separator"></div>
                <div class="analysis-content">
                    ${characters.length > 0 ? 
                        characters.map(char => `<p><strong>${char}</strong></p>`).join('') :
                        '<p><em>No character list found in this play.</em></p>'
                    }
                </div>
            `;
        }

        // Show Act overview
        function showAct(actName) {
            if (!currentPlay || !plays[currentPlay] || !plays[currentPlay].acts[actName]) return;
            
            const scenes = plays[currentPlay].acts[actName];
            const playText = document.getElementById('playText');
            
            // Update active navigation
            updateActiveNavigation(actName);
            
            playText.innerHTML = `
                <div class="scene-title">${actName}</div>
                <div class="scene-separator"></div>
                <div class="analysis-content">
                    <p>This act contains ${scenes.length} scene${scenes.length !== 1 ? 's' : ''}:</p>
                    ${scenes.map(scene => `<p><a href="#" onclick="loadScene('${scene}')">${scene.split(' - ')[1]}</a></p>`).join('')}
                </div>
            `;
        }

        // Change play
        function changePlay() {
            const selector = document.getElementById('playSelector');
            const selectedPlay = selector.value;
            if (selectedPlay) {
                loadPlay(selectedPlay);
            }
        }

        // Text selection functionality
        document.addEventListener('mouseup', function() {
            const selection = window.getSelection();
            selectedText = selection.toString().trim();
            
            if (selectedText) {
                // Highlight the selected text
                const range = selection.getRangeAt(0);
                const span = document.createElement('span');
                span.className = 'highlighted';
                range.surroundContents(span);
            }
        });

        function explainHighlighted() {
            if (!selectedText) {
                alert('Please highlight some text first, then click "Explain Highlighted Text".');
                return;
            }
            
            // Call the serverless function to analyze the highlighted text
            analyzeHighlightedText(selectedText);
        }

        async function analyzeHighlightedText(text) {
            try {
                const response = await fetch('/.netlify/functions/shakespeare', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        text: text,
                        level: 'detailed',
                        model: 'gpt-4o-mini'
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.choices && data.choices[0] && data.choices[0].message) {
                    updateAnalysis(data.choices[0].message.content, text);
                }
                
            } catch (error) {
                console.error('Error analyzing text:', error);
                alert('Error analyzing text. Please try again.');
            }
        }

        function updateAnalysis(content, text) {
            const analysisPanel = document.getElementById('analysisPanel');
            const wordCount = text.split(' ').length;
            const playInfo = currentPlay ? `${currentPlay} · ${currentScene}` : 'Unknown Play';
            
            analysisPanel.innerHTML = `
                <div class="analysis-section">
                    <div class="analysis-header">
                        <div class="analysis-title">Basic Analysis</div>
                        <button class="copy-btn">Copy</button>
                    </div>
                    <div class="selection-info">${playInfo} — ${wordCount} words selected</div>
                </div>

                <div class="analysis-section">
                    <div class="analysis-title">Analysis</div>
                    <div class="analysis-content">
                        ${content}
                    </div>
                </div>

                <div class="follow-up-section">
                    <div class="analysis-title">Ask a follow-up question</div>
                    <div class="follow-up-input">
                        <input type="text" placeholder="Ask a follow-up question..." id="followUpQuestion">
                        <button class="ask-btn" onclick="askFollowUp()">Ask</button>
                    </div>
                </div>
            `;
        }

        function askFollowUp() {
            const question = document.getElementById('followUpQuestion').value.trim();
            if (!question) {
                alert('Please enter a question.');
                return;
            }
            
            // Here you would implement follow-up question functionality
            alert('Follow-up question feature coming soon!');
        }
    </script>

    <!-- Footer About Section -->
    <div class="footer-about">
        <h3>About This Project</h3>
        <p>Shakespeare Digital Variorum combines centuries of scholarly commentary with AI analysis. All Shakespeare texts are public domain and based on the Folger Shakespeare Library editions of each play. Scholarly sources are cited throughout and used under fair use for educational purposes. This site is freely available for non-commercial educational use.</p>
        <p class="footer-attribution">Created by Jack David Carson, Massachusetts Institute of Technology • 2025 • <a href="#" onclick="openRights(); return false;">Full Rights & Usage Information</a></p>
    </div>
</body>
</html>
